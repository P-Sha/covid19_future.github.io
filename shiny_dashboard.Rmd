---
title: "Shiny Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    source_code: embed
runtime: shiny
---
```{r setup, include=FALSE}
library(tidyverse)
library(viridis)

library(plotly)
library(flexdashboard)
library(leaflet)
library(geojsonio)
library(rsconnect)
library(shiny)

# deployApp('./shiny_dashboard.Rmd')
```

```{r create_df, include=FALSE}

####### Country polygons

countries <- geojson_read("./data/countries.geo.json", what = "sp")


## H1N1 data 4/24/09 to 7/6/09

h1n1_df = read_csv("./data/h1n1_data.csv") %>%
  janitor::clean_names() %>%
  group_by(country) %>%
  summarize(
    h1n1 = sum(cumulative_no_of_cases),
  ) %>% 
  rename(name = country) %>% 
  mutate(
    name = str_replace(name, "Guernsey, Crown Dependency", "Guernsey"),
    name = str_replace(name, "Hong Kong Special Administrative Region", "Hong Kong"),
    name = str_replace(name, "Viet Nam", "Vietnam")
  )


# Covid Data
covid_df = read_csv("./data/covid19_global.csv") %>% 
  janitor::clean_names() %>% 
  group_by(country) %>% 
  summarize(
    covid = max(cumulative_cases)
  ) %>% 
  mutate(
    name = country,
    name = str_replace(name, "Venezuela \\(Bolivarian Republic of\\)", "Venezuela"),
    name = str_replace(name, "Iran \\(Islamic Republic of\\)", "Iran"),
    name = str_replace(name, "Russian Federation", "Russia"),
    name = str_replace(name, "The United Kingdom", "United Kingdom"),
    name = str_replace(name, "Bolivia \\(Plurinational State of\\)", "Bolivia"),
    name = str_replace(name, "Congo", "Republic of the Congo"),
    name = str_replace(name, "Syrian Arab Republic", "Syria"),
    name = str_replace(name, "Czechia", "Czech Republic"),
    name = str_replace(name, "Serbia", "Republic of Serbia"),
    name = str_replace(name, "Republic of Moldova", "Moldova"),
    name = str_replace(name, "Guinea-Bissau", "Guinea Bissau"),
    name = str_replace(name, "Lao People's Democratic Republic", "Laos"),
    name = str_replace(name, "Viet Nam", "Vietnam"),
    name = str_replace(name, "Republic of Korea", "South Korea"),
    name = str_replace(name, "Falkland Islands (Malvinas)", "Falkland Islands"),
    name = str_replace(name, "Democratic Republic of the Republic of the Congo", "Democratic Republic of the Congo")
  ) %>% 
  select(name, covid)


#SARS Data
sars_df = 
  read_csv("./data/sars_2003_complete_dataset_clean.csv") %>% 
  janitor::clean_names() %>% 
  select(-number_recovered) %>% 
  group_by(country) %>% 
  filter(date == max(date)) %>% 
  rename(
    name = country,
    sars = cumulative_number_of_case_s
  ) %>% 
  mutate(
    name = str_replace(name, "Viet Nam", "Vietnam"),
    name = str_replace(name, "Russian Federation", "Russia"),
    name = str_replace(name, "Republic of Korea", "South Korea"),
    name = str_replace(name, "United States", "United States of America")
  ) %>% 
  select(name, sars)


big_test = full_join(covid_df, sars_df, by = "name") %>% 
  full_join(h1n1_df, by = "name") 

big_test2 = full_join(covid_df, sars_df, by = "name") %>% 
  full_join(h1n1_df, by = "name") %>% 
  pivot_longer(cols = -name, 
               names_to = "disease",
               values_to = "cum_cases")


pan_countries_map = sp::merge(x = countries, y = big_test, by = "name", all.x = TRUE)

disease_pal = function(disease){
  if(disease == "covid" || disease == "h1n1") {
    pal = colorBin(palette = "YlOrRd", bins = c(1, 100, 1000, 5000, 10000, 50000, 100000, 500000, 1000000, Inf), na.color = "#808080")
  }
  
  if(disease == "sars") {
    pal = colorBin(palette = "YlOrRd", bins = c(1, 10, 100, 500, 1000, 5000, Inf), na.color = "#808080")
  }

  pal 
}

```

Column {.sidebar}
-----------------------------------------------------------------------
```{r shiny_inputs}
disease_choices = big_test2 %>% pull(disease) %>% unique()
# 
selectInput(
  "disease_choice",
  h3("Pandemic:"),
  choices = disease_choices,
  selected = "covid"
)

# sliderInput(
#   "price_range",
#   h3("Price Range"),
#   100, 1000, 
#   value = c(100, 400))

# room_choices = nyc_airbnb %>% pull(room_type) %>% unique()
# radioButtons(
#   "room_choice",
#   h3("Room Type"),
#   choices = room_choices
# )
```

Row {data-height=750}
-------------------------------------
### covid Map
```{r}

lables = paste0("<strong>Country: </strong>",
                  pan_countries_map$name,
                  "<br><strong># of cases: </strong>",
                  pan_countries_map$input[["disease_choice"]])

renderLeaflet({
    big_test2 %>%
    filter(disease == input[["disease_choice"]]) %>%
    select(name, cum_cases) %>%
    sp::merge(x = countries, by = "name", all.x = TRUE) %>%
    leaflet() %>%
    addTiles() %>%
    addPolygons(fillColor = ~disease_pal(input[["disease_choice"]])(cum_cases),
    weight = 1.5,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    popup = lables) %>%
    addLegend(
      "bottomright",
      pal = disease_pal(input[["disease_choice"]]),
      values = ~cum_cases,
      title = "Quantile",
      opacity = 1
    )
})

```

## sars map
```{r}
lables = paste0("<strong>Country: </strong>",
                  pan_countries_map$name,
                  "<br><strong># of cases: </strong>",
                  pan_countries_map$input[["disease_choice"]])

renderLeaflet({
    big_test2 %>%
    filter(disease == input[["disease_choice"]]) %>%
    select(name, cum_cases) %>%
    sp::merge(x = countries, by = "name", all.x = TRUE) %>%
    leaflet() %>%
    addTiles() %>%
    addPolygons(fillColor = ~disease_pal(input[["disease_choice"]])(cum_cases),
    weight = 1.5,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    popup = lables) %>%
    addLegend(
      "bottomright",
      pal = disease_pal(input[["disease_choice"]]),
      values = ~cum_cases,
      title = "Quantile",
      opacity = 1
    )
})
```

Row {data-height=350}
-------------------------------------
```{r}
renderPlotly({
  big_test2 %>%
    filter(disease == input[["disease_choice"]]) %>%
    mutate(name = fct_reorder(name, cum_cases),
           rank = rank(desc(cum_cases))) %>%
    filter(rank <= 15) %>% 
    plot_ly(
      x = ~cum_cases,
      y = ~name,
      type = "bar",
      colors = ~cum_cases)
})
```

```{r}
renderPrint(
  input[["disease_choice"]]
)
```
